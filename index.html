<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Signalement G√©ographique</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body { 
            margin: 0; 
            padding: 10px; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            margin-top: 0;
            color: #333;
        }
        
        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .alert a {
            color: #856404;
            text-decoration: underline;
        }
        
        #map { 
            height: 450px; 
            width: 100%; 
            margin-bottom: 20px;
            border-radius: 4px;
            border: 2px solid #dee2e6;
        }
        
        #form {
            padding: 0;
        }
        
        .field {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .mode-selector {
            margin-bottom: 15px;
        }
        
        .mode-btn {
            padding: 8px 15px;
            font-size: 13px;
        }
        
        .mode-btn.active {
            background: #0056b3;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 4px;
            display: none;
            font-weight: 500;
        }
        
        #status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        #status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        #status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .readonly-field {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .iframe-notice {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .iframe-notice strong {
            display: block;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
            }
            
            #map {
                height: 300px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üìç Nouveau signalement</h2>
    
    <!-- Alerte iframe/g√©oloc -->
    <div class="iframe-notice" id="iframe-notice" style="display: none;">
        <strong>üí° Dans une iframe Grist ?</strong>
        La g√©olocalisation peut √™tre bloqu√©e. 
        <a href="#" onclick="openFullscreen(); return false;">Cliquez ici pour ouvrir en plein √©cran</a>, 
        g√©olocalisez-vous, puis revenez ici : votre position sera automatiquement r√©cup√©r√©e !
    </div>
    
    <!-- Boutons d'action -->
    <div class="button-group">
        <button class="btn-warning" id="geoloc-btn" onclick="testGeolocation()">
            üìç Me g√©olocaliser
        </button>
        <button class="btn-secondary" onclick="openFullscreen()">
            üöÄ Ouvrir en plein √©cran
        </button>
    </div>
    
    <!-- S√©lecteur de mode -->
    <div class="mode-selector">
        <strong>Type de g√©om√©trie :</strong>
        <div class="button-group">
            <button class="mode-btn btn-primary active" data-mode="point" onclick="selectMode('point')">
                üìç Point
            </button>
            <button class="mode-btn btn-primary" data-mode="line" onclick="selectMode('line')">
                üìè Ligne
            </button>
            <button class="mode-btn btn-primary" data-mode="polygon" onclick="selectMode('polygon')">
                ‚¨ü Polygone
            </button>
        </div>
    </div>
    
    <!-- Carte -->
    <div id="map"></div>
    
    <!-- Formulaire -->
    <div id="form">
        <div class="field">
            <label for="type">Type de signalement *</label>
            <select id="type" required>
                <option value="">-- S√©lectionner --</option>
                <option>Nid de poule</option>
                <option>Fuite d'eau</option>
                <option>√âclairage d√©fectueux</option>
                <option>D√©gradation</option>
                <option>Autre</option>
            </select>
        </div>
        
        <div class="field">
            <label for="description">Description</label>
            <textarea id="description" placeholder="D√©crivez le probl√®me..."></textarea>
        </div>
        
        <div class="field">
            <label for="geojson">GeoJSON (g√©n√©r√© automatiquement)</label>
            <textarea id="geojson" class="readonly-field" rows="3" readonly></textarea>
        </div>
        
        <button class="btn-success" onclick="submitForm()" style="width: 100%; font-size: 16px;">
            üì§ Envoyer le signalement
        </button>
        
        <div id="status"></div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

<script>
// ====== CONFIGURATION ======
const DEFAULT_CENTER = [48.2020, -2.9326]; // Rennes, Bretagne
const DEFAULT_ZOOM = 13;

// ====== VARIABLES GLOBALES ======
let map;
let drawnItems;
let currentMode = 'point';
let currentGeometry = null;
let currentDrawControl = null;
let isInIframe = false;
let gristReady = false;

// ====== D√âTECTION IFRAME ======
try {
    isInIframe = window.self !== window.top;
    if (isInIframe) {
        document.getElementById('iframe-notice').style.display = 'block';
    }
} catch (e) {
    isInIframe = true;
    document.getElementById('iframe-notice').style.display = 'block';
}

// ====== INITIALISATION CARTE ======
function initMap() {
    try {
        map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        // Click pour mode Point
        map.on('click', function(e) {
            if (currentMode === 'point') {
                drawnItems.clearLayers();
                L.marker(e.latlng).addTo(drawnItems);
                updateGeoJSON({
                    type: 'Point',
                    coordinates: [e.latlng.lng, e.latlng.lat]
                });
                showStatus('‚úÖ Point plac√©. Remplissez le formulaire et envoyez.', 'info');
            }
        });
        
        console.log('‚úÖ Carte initialis√©e');
        
        // ===== R√âCUP√âRER LA G√âOLOC DEPUIS LOCALSTORAGE =====
        try {
            const savedGeoloc = localStorage.getItem('grist_geoloc');
            if (savedGeoloc) {
                const geoloc = JSON.parse(savedGeoloc);
                const [lon, lat] = geoloc.coordinates;
                const age = Date.now() - new Date(geoloc.timestamp).getTime();
                
                // Utiliser seulement si moins de 5 minutes
                if (age < 5 * 60 * 1000) {
                    map.setView([lat, lon], 17);
                    drawnItems.clearLayers();
                    const marker = L.marker([lat, lon]).addTo(drawnItems);
                    marker.bindPopup(`üìç Position r√©cup√©r√©e !<br>Pr√©cision: ${Math.round(geoloc.accuracy || 0)}m`).openPopup();
                    
                    updateGeoJSON({
                        type: 'Point',
                        coordinates: [lon, lat]
                    });
                    
                    showStatus('‚úÖ Votre position a √©t√© automatiquement r√©cup√©r√©e !', 'success');
                    
                    // Nettoyer apr√®s utilisation
                    localStorage.removeItem('grist_geoloc');
                } else {
                    // Trop vieux, on supprime
                    localStorage.removeItem('grist_geoloc');
                    showStatus('üëÜ Cliquez sur la carte pour placer un point', 'info');
                }
            } else {
                showStatus('üëÜ Cliquez sur la carte pour placer un point', 'info');
            }
        } catch (e) {
            console.error('Erreur r√©cup√©ration localStorage:', e);
            showStatus('üëÜ Cliquez sur la carte pour placer un point', 'info');
        }
        
    } catch (error) {
        console.error('‚ùå Erreur initialisation carte:', error);
        showStatus('‚ùå Erreur lors du chargement de la carte', 'error');
    }
}

// ====== INITIALISATION GRIST ======
function initGrist() {
    try {
        grist.ready({ requiredAccess: 'full' });
        gristReady = true;
        console.log('‚úÖ Grist API pr√™te');
    } catch (err) {
        console.warn('‚ö†Ô∏è Grist API non disponible (mode standalone)', err);
        gristReady = false;
    }
}

// ====== S√âLECTION DU MODE ======
function selectMode(mode) {
    if (!map) {
        showStatus('‚ùå Carte non initialis√©e', 'error');
        return;
    }
    
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
            btn.classList.add('active');
        }
    });
    
    currentMode = mode;
    drawnItems.clearLayers();
    updateGeoJSON(null);
    
    if (currentDrawControl) {
        currentDrawControl.disable();
        currentDrawControl = null;
    }
    
    if (mode === 'point') {
        showStatus('üëÜ Cliquez sur la carte pour placer un point', 'info');
    } else if (mode === 'line') {
        enableDrawing('polyline');
        showStatus('üìè Cliquez sur la carte pour tracer une ligne. Double-clic pour terminer.', 'info');
    } else if (mode === 'polygon') {
        enableDrawing('polygon');
        showStatus('‚¨ü Cliquez sur la carte pour tracer un polygone. Double-clic pour terminer.', 'info');
    }
}

// ====== ACTIVER LE DESSIN ======
function enableDrawing(type) {
    let options = {
        shapeOptions: { 
            color: '#3388ff',
            weight: 3
        }
    };
    
    if (type === 'polyline') {
        currentDrawControl = new L.Draw.Polyline(map, options);
    } else if (type === 'polygon') {
        currentDrawControl = new L.Draw.Polygon(map, options);
    }
    
    currentDrawControl.enable();
    
    map.once('draw:created', function(e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
        
        let coords = [];
        let geojsonType = '';
        
        if (type === 'polyline') {
            coords = e.layer.getLatLngs().map(ll => [ll.lng, ll.lat]);
            geojsonType = 'LineString';
        } else if (type === 'polygon') {
            coords = e.layer.getLatLngs()[0].map(ll => [ll.lng, ll.lat]);
            coords.push(coords[0]);
            geojsonType = 'Polygon';
        }
        
        updateGeoJSON({
            type: geojsonType,
            coordinates: type === 'polygon' ? [coords] : coords
        });
        
        showStatus('‚úÖ G√©om√©trie trac√©e. Remplissez le formulaire et envoyez.', 'info');
    });
}

// ====== METTRE √Ä JOUR GEOJSON ======
function updateGeoJSON(geometry) {
    currentGeometry = geometry;
    document.getElementById('geojson').value = geometry ? 
        JSON.stringify(geometry, null, 2) : '';
}

// ====== TEST G√âOLOCALISATION ======
function testGeolocation() {
    if (!map) {
        showStatus('‚ùå Carte non initialis√©e', 'error');
        return;
    }
    
    if (!navigator.geolocation) {
        showStatus('‚ùå G√©olocalisation non support√©e par ce navigateur', 'error');
        return;
    }
    
    showStatus('‚è≥ Demande de g√©olocalisation en cours...', 'info');
    
    const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
    };
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            const geoloc = {
                type: 'Point',
                coordinates: [lon, lat],
                timestamp: new Date().toISOString(),
                accuracy: accuracy
            };
            
            // ===== SAUVEGARDER DANS LOCALSTORAGE =====
            try {
                localStorage.setItem('grist_geoloc', JSON.stringify(geoloc));
                console.log('‚úÖ G√©oloc sauvegard√©e dans localStorage');
            } catch (e) {
                console.error('Erreur localStorage:', e);
            }
            
            showStatus(`‚úÖ Position obtenue ! Pr√©cision: ${Math.round(accuracy)}m`, 'success');
            
            if (!isInIframe) {
                setTimeout(() => {
                    showStatus('üí° Position sauvegard√©e ! Revenez dans Grist, elle sera automatiquement charg√©e.', 'info');
                }, 2000);
            }
            
            map.setView([lat, lon], 17);
            
            drawnItems.clearLayers();
            const marker = L.marker([lat, lon]).addTo(drawnItems);
            marker.bindPopup(`üìç Votre position<br>Pr√©cision: ${Math.round(accuracy)}m`).openPopup();
            
            updateGeoJSON(geoloc);
        },
        function(error) {
            let msg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    msg = '‚ùå Permission refus√©e. ';
                    if (isInIframe) {
                        msg += 'La g√©olocalisation est bloqu√©e dans l\'iframe. Cliquez sur "Ouvrir en plein √©cran" ci-dessus.';
                    } else {
                        msg += 'Autorisez la g√©olocalisation dans votre navigateur.';
                    }
                    break;
                case error.POSITION_UNAVAILABLE:
                    msg = '‚ùå Position non disponible. V√©rifiez vos param√®tres GPS.';
                    break;
                case error.TIMEOUT:
                    msg = '‚ùå D√©lai d√©pass√©. R√©essayez.';
                    break;
            }
            showStatus(msg, 'error');
        },
        options
    );
}

// ====== OUVRIR EN PLEIN √âCRAN ======
function openFullscreen() {
    const currentUrl = window.location.href;
    window.open(currentUrl, '_blank');
    showStatus('‚úÖ Page ouverte dans un nouvel onglet. G√©olocalisez-vous puis revenez ici !', 'success');
}

// ====== SOUMETTRE LE FORMULAIRE ======
async function submitForm() {
    const type = document.getElementById('type').value;
    const description = document.getElementById('description').value;
    
    if (!type) {
        showStatus('‚ùå Veuillez s√©lectionner un type de signalement', 'error');
        return;
    }
    
    if (!currentGeometry) {
        showStatus('‚ùå Veuillez placer une g√©om√©trie sur la carte', 'error');
        return;
    }
    
    const data = {
        type: type,
        description: description || '',
        geojson: JSON.stringify(currentGeometry),
        geometrie_type: currentGeometry.type,
        date: new Date().toISOString()
    };
    
    showStatus('‚è≥ Envoi en cours...', 'info');
    
    try {
        if (gristReady) {
            await grist.docApi.applyUserActions([
                ['AddRecord', 'Signalement', null, data]
            ]);
            
            showStatus('‚úÖ Signalement envoy√© avec succ√®s √† Grist !', 'success');
        } else {
            console.log('Donn√©es √† envoyer:', data);
            showStatus('‚ö†Ô∏è Mode test - Grist non connect√©. Utilisez depuis l\'iframe Grist pour enregistrer.', 'error');
        }
        
        setTimeout(() => {
            document.getElementById('type').value = '';
            document.getElementById('description').value = '';
            drawnItems.clearLayers();
            updateGeoJSON(null);
        }, 2000);
        
    } catch (err) {
        console.error('Erreur:', err);
        showStatus('‚ùå Erreur lors de l\'envoi : ' + err.message, 'error');
    }
}

// ====== AFFICHER UN MESSAGE ======
function showStatus(message, type) {
    const status = document.getElementById('status');
    
    if (!message) {
        status.style.display = 'none';
        return;
    }
    
    status.textContent = message;
    status.className = type;
    status.style.display = 'block';
    
    if (type === 'info') {
        setTimeout(() => {
            if (status.className === 'info') {
                status.style.display = 'none';
            }
        }, 5000);
    }
}

// ====== INITIALISATION TOTALE ======
// Initialiser la carte d√®s que possible
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        initGrist();
    });
} else {
    initMap();
    initGrist();
}
</script>

</body>
</html>
