<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Signalements - Ille-et-Vilaine</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            cursor: crosshair;
        }
        
        .instruction-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: 600;
            font-size: 14px;
            pointer-events: none;
        }
        
        .popup-form {
            width: 320px;
            padding: 0;
        }
        
        .popup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: -20px -20px 15px -20px;
            border-radius: 12px 12px 0 0;
        }
        
        .popup-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .popup-coords {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .checkbox-item input {
            width: auto;
        }
        
        .checkbox-item label {
            margin: 0;
            font-weight: 400;
            font-size: 12px;
        }
        
        .btn-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-submit:hover {
            opacity: 0.9;
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-cancel {
            width: 100%;
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            text-align: center;
            font-weight: 600;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content {
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="instruction-banner">
        üìç Cliquez sur la carte pour cr√©er un signalement
    </div>
    
    <div id="map"></div>

    <script>
        let map;
        let tempMarker = null;
        let gristAPI = null;
        let isInGrist = false;
        
        const GRIST_CONFIG = {
            apiUrl: 'https://grist.numerique.gouv.fr/api/docs/g2HLa3eYrAStdHNxgpmBPr/tables/Signalements/records',
            apiKey: 'c6ba01a7d00347cd2ab2f051df5d6acab380afbf'
        };
        
        // D√©tecter si on est dans Grist
        if (typeof grist !== 'undefined') {
            isInGrist = true;
            grist.ready({ requiredAccess: 'full' });
            grist.onOptions(function(options) {
                gristAPI = grist;
                console.log('Grist ready!');
            });
        }
        
        // Initialiser la carte
        function initMap() {
            // V√©rifier que Leaflet est charg√©
            if (typeof L === 'undefined') {
                console.log('Leaflet pas charg√©, r√©essai...');
                setTimeout(initMap, 300);
                return;
            }
            
            console.log('Initialisation carte...');
            
            map = L.map('map').setView([48.1173, -1.6778], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 18
            }).addTo(map);
            
            // Clic sur la carte
            map.on('click', onMapClick);
            
            console.log('Carte pr√™te !');
        }
        
        async function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Supprimer l'ancien marqueur temporaire
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            
            // Cr√©er un nouveau marqueur temporaire
            tempMarker = L.marker([lat, lng]).addTo(map);
            
            // R√©cup√©rer l'adresse
            let adresseInfo = { route: '', commune: '' };
            try {
                const response = await fetch(
                    `https://api-adresse.data.gouv.fr/reverse/?lon=${lng}&lat=${lat}`
                );
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const props = data.features[0].properties;
                    
                    if (props.city || props.municipality) {
                        adresseInfo.commune = props.city || props.municipality;
                    }
                    
                    if (props.name) {
                        const routeMatch = props.name.match(/^([DN]|RD|RN)\s*(\d+)/i);
                        if (routeMatch) {
                            adresseInfo.route = routeMatch[0].replace(/\s+/g, '');
                        } else if (props.street) {
                            adresseInfo.route = props.street;
                        }
                    } else if (props.street) {
                        adresseInfo.route = props.street;
                    }
                }
            } catch (error) {
                console.error('Erreur g√©ocodage:', error);
            }
            
            // Ouvrir le formulaire dans un popup
            showFormPopup(lat, lng, adresseInfo);
        }
        
        function showFormPopup(lat, lng, adresseInfo) {
            const popupContent = `
                <div class="popup-form">
                    <div class="popup-header">
                        <h3>üìç Nouveau signalement</h3>
                        <div class="popup-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                    </div>
                    
                    <div id="message"></div>
                    
                    <div class="form-group">
                        <label>Nom de l'agent *</label>
                        <input type="text" id="agent" placeholder="Ex: Jean Dupont" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Route *</label>
                        <input type="text" id="route" value="${adresseInfo.route}" placeholder="Ex: D137" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Commune *</label>
                        <input type="text" id="commune" value="${adresseInfo.commune}" placeholder="Ex: Rennes" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Type de coupure *</label>
                        <select id="typeCoupure">
                            <option value="Totale">Totale</option>
                            <option value="Partielle">Partielle</option>
                            <option value="D√©viation">D√©viation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Cause(s) *</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="c1" value="Inondation">
                                <label for="c1">Inondation</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c2" value="Accident">
                                <label for="c2">Accident</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c3" value="Travaux">
                                <label for="c3">Travaux</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c4" value="Arbre">
                                <label for="c4">Arbre</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c5" value="Glissement">
                                <label for="c5">Glissement</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c6" value="Autre">
                                <label for="c6">Autre</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Priorit√© *</label>
                        <select id="priorite">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="description" rows="3" placeholder="D√©tails..."></textarea>
                    </div>
                    
                    <button class="btn-submit" onclick="submitSignalement(${lat}, ${lng})">
                        ‚úì Cr√©er le signalement
                    </button>
                    
                    <button class="btn-cancel" onclick="cancelSignalement()">
                        Annuler
                    </button>
                </div>
            `;
            
            tempMarker.bindPopup(popupContent, {
                maxWidth: 350,
                closeButton: false
            }).openPopup();
        }
        
        window.submitSignalement = async function(lat, lng) {
            const agent = document.getElementById('agent').value.trim();
            const route = document.getElementById('route').value.trim();
            const commune = document.getElementById('commune').value.trim();
            const typeCoupure = document.getElementById('typeCoupure').value;
            const priorite = document.getElementById('priorite').value;
            const description = document.getElementById('description').value.trim();
            
            const causes = [];
            for (let i = 1; i <= 6; i++) {
                const cb = document.getElementById('c' + i);
                if (cb && cb.checked) causes.push(cb.value);
            }
            
            // Validation
            if (!agent || !route || !commune) {
                showPopupMessage('error', 'Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (causes.length === 0) {
                showPopupMessage('error', 'S√©lectionnez au moins une cause');
                return;
            }
            
            // D√©sactiver le bouton
            const btn = document.querySelector('.btn-submit');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>Envoi...';
            
            try {
                if (isInGrist && gristAPI) {
                    // Mode Grist Widget
                    const record = {
                        Date_heure: new Date().toISOString(),
                        Agent: agent,
                        Latitude: lat,
                        Longitude: lng,
                        Route: route,
                        Commune: commune,
                        Type_coupure: typeCoupure,
                        Cause: ['L', ...causes],
                        Description: description,
                        Statut: 'Actif',
                        Priorite: priorite
                    };
                    
                    await gristAPI.docApi.applyUserActions([
                        ['AddRecord', 'Signalements', null, record]
                    ]);
                } else {
                    // Mode Standalone
                    const record = {
                        Date_heure: new Date().toISOString(),
                        Agent: agent,
                        Latitude: lat,
                        Longitude: lng,
                        Route: route,
                        Commune: commune,
                        Type_coupure: typeCoupure,
                        Cause: causes,
                        Description: description,
                        Statut: 'Actif',
                        Priorite: priorite
                    };
                    
                    const response = await fetch(GRIST_CONFIG.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${GRIST_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ records: [{ fields: record }] })
                    });
                    
                    if (!response.ok) throw new Error('Erreur API');
                }
                
                showPopupMessage('success', '‚úì Signalement cr√©√© !');
                
                setTimeout(() => {
                    map.closePopup();
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Erreur:', error);
                showPopupMessage('error', 'Erreur lors de la cr√©ation: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '‚úì Cr√©er le signalement';
            }
        };
        
        window.cancelSignalement = function() {
            map.closePopup();
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        };
        
        function showPopupMessage(type, text) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type === 'success' ? 'success-message' : 'error-message';
            msgDiv.textContent = text;
            msgDiv.style.display = 'block';
        }
        
        // Initialiser
        setTimeout(initMap, 1000);
    </script>
</body>
</html>
