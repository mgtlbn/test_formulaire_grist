<script>
// ====== CONFIGURATION ======
const DEFAULT_CENTER = [48.2020, -2.9326]; // Rennes, Bretagne
const DEFAULT_ZOOM = 13;

// ====== VARIABLES GLOBALES ======
let map;
let drawnItems;
let currentMode = 'point';
let currentGeometry = null;
let currentDrawControl = null;
let isInIframe = false;
let gristReady = false;

// ====== D√âTECTION IFRAME ======
try {
    isInIframe = window.self !== window.top;
    if (isInIframe) {
        document.getElementById('iframe-notice').style.display = 'block';
    }
} catch (e) {
    isInIframe = true;
    document.getElementById('iframe-notice').style.display = 'block';
}

// ====== INITIALISATION CARTE ======
function initMap() {
    try {
        map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        // Click pour mode Point
        map.on('click', function(e) {
            if (currentMode === 'point') {
                drawnItems.clearLayers();
                L.marker(e.latlng).addTo(drawnItems);
                updateGeoJSON({
                    type: 'Point',
                    coordinates: [e.latlng.lng, e.latlng.lat]
                });
                showStatus('‚úÖ Point plac√©. Remplissez le formulaire et envoyez.', 'info');
            }
        });
        
        console.log('‚úÖ Carte initialis√©e');
        showStatus('üëÜ Cliquez sur la carte pour placer un point', 'info');
    } catch (error) {
        console.error('‚ùå Erreur initialisation carte:', error);
        showStatus('‚ùå Erreur lors du chargement de la carte', 'error');
    }
}

// ====== INITIALISATION GRIST ======
function initGrist() {
    try {
        grist.ready({ requiredAccess: 'full' });
        gristReady = true;
        console.log('‚úÖ Grist API pr√™te');
    } catch (err) {
        console.warn('‚ö†Ô∏è Grist API non disponible (mode standalone)', err);
        gristReady = false;
    }
}

// ====== S√âLECTION DU MODE ======
function selectMode(mode) {
    if (!map) {
        showStatus('‚ùå Carte non initialis√©e', 'error');
        return;
    }
    
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
            btn.classList.add('active');
        }
    });
    
    currentMode = mode;
    drawnItems.clearLayers();
    updateGeoJSON(null);
    
    if (currentDrawControl) {
        currentDrawControl.disable();
        currentDrawControl = null;
    }
    
    if (mode === 'point') {
        showStatus('üëÜ Cliquez sur la carte pour placer un point', 'info');
    } else if (mode === 'line') {
        enableDrawing('polyline');
        showStatus('üìè Cliquez sur la carte pour tracer une ligne. Double-clic pour terminer.', 'info');
    } else if (mode === 'polygon') {
        enableDrawing('polygon');
        showStatus('‚¨ü Cliquez sur la carte pour tracer un polygone. Double-clic pour terminer.', 'info');
    }
}

// ====== ACTIVER LE DESSIN ======
function enableDrawing(type) {
    let options = {
        shapeOptions: { 
            color: '#3388ff',
            weight: 3
        }
    };
    
    if (type === 'polyline') {
        currentDrawControl = new L.Draw.Polyline(map, options);
    } else if (type === 'polygon') {
        currentDrawControl = new L.Draw.Polygon(map, options);
    }
    
    currentDrawControl.enable();
    
    map.once('draw:created', function(e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
        
        let coords = [];
        let geojsonType = '';
        
        if (type === 'polyline') {
            coords = e.layer.getLatLngs().map(ll => [ll.lng, ll.lat]);
            geojsonType = 'LineString';
        } else if (type === 'polygon') {
            coords = e.layer.getLatLngs()[0].map(ll => [ll.lng, ll.lat]);
            coords.push(coords[0]);
            geojsonType = 'Polygon';
        }
        
        updateGeoJSON({
            type: geojsonType,
            coordinates: type === 'polygon' ? [coords] : coords
        });
        
        showStatus('‚úÖ G√©om√©trie trac√©e. Remplissez le formulaire et envoyez.', 'info');
    });
}

// ====== METTRE √Ä JOUR GEOJSON ======
function updateGeoJSON(geometry) {
    currentGeometry = geometry;
    document.getElementById('geojson').value = geometry ? 
        JSON.stringify(geometry, null, 2) : '';
}

// ====== TEST G√âOLOCALISATION ======
function testGeolocation() {
    if (!map) {
        showStatus('‚ùå Carte non initialis√©e', 'error');
        return;
    }
    
    if (!navigator.geolocation) {
        showStatus('‚ùå G√©olocalisation non support√©e par ce navigateur', 'error');
        return;
    }
    
    showStatus('‚è≥ Demande de g√©olocalisation en cours...', 'info');
    
    const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
    };
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            showStatus(`‚úÖ Position obtenue ! Pr√©cision: ${Math.round(accuracy)}m`, 'success');
            
            map.setView([lat, lon], 17);
            
            drawnItems.clearLayers();
            const marker = L.marker([lat, lon]).addTo(drawnItems);
            marker.bindPopup(`üìç Votre position<br>Pr√©cision: ${Math.round(accuracy)}m`).openPopup();
            
            updateGeoJSON({
                type: 'Point',
                coordinates: [lon, lat]
            });
        },
        function(error) {
            let msg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    msg = '‚ùå Permission refus√©e. ';
                    if (isInIframe) {
                        msg += 'La g√©olocalisation est bloqu√©e dans l\'iframe. Cliquez sur "Ouvrir en plein √©cran" ci-dessus.';
                    } else {
                        msg += 'Autorisez la g√©olocalisation dans votre navigateur.';
                    }
                    break;
                case error.POSITION_UNAVAILABLE:
                    msg = '‚ùå Position non disponible. V√©rifiez vos param√®tres GPS.';
                    break;
                case error.TIMEOUT:
                    msg = '‚ùå D√©lai d√©pass√©. R√©essayez.';
                    break;
            }
            showStatus(msg, 'error');
        },
        options
    );
}

// ====== OUVRIR EN PLEIN √âCRAN ======
function openFullscreen() {
    const currentUrl = window.location.href;
    window.open(currentUrl, '_blank');
    showStatus('‚úÖ Page ouverte dans un nouvel onglet. La g√©olocalisation devrait y fonctionner !', 'success');
}

// ====== SOUMETTRE LE FORMULAIRE ======
async function submitForm() {
    const type = document.getElementById('type').value;
    const description = document.getElementById('description').value;
    
    if (!type) {
        showStatus('‚ùå Veuillez s√©lectionner un type de signalement', 'error');
        return;
    }
    
    if (!currentGeometry) {
        showStatus('‚ùå Veuillez placer une g√©om√©trie sur la carte', 'error');
        return;
    }
    
    const data = {
        type: type,
        description: description || '',
        geojson: JSON.stringify(currentGeometry),
        geometrie_type: currentGeometry.type,
        date: new Date().toISOString()
    };
    
    showStatus('‚è≥ Envoi en cours...', 'info');
    
    try {
        if (gristReady) {
            await grist.docApi.applyUserActions([
                ['AddRecord', 'Signalement', null, data]
            ]);
            
            showStatus('‚úÖ Signalement envoy√© avec succ√®s √† Grist !', 'success');
        } else {
            console.log('Donn√©es √† envoyer:', data);
            showStatus('‚úÖ Donn√©es pr√©par√©es (mode test - Grist non connect√©)', 'success');
        }
        
        setTimeout(() => {
            document.getElementById('type').value = '';
            document.getElementById('description').value = '';
            drawnItems.clearLayers();
            updateGeoJSON(null);
        }, 2000);
        
    } catch (err) {
        console.error('Erreur:', err);
        showStatus('‚ùå Erreur lors de l\'envoi : ' + err.message, 'error');
    }
}

// ====== AFFICHER UN MESSAGE ======
function showStatus(message, type) {
    const status = document.getElementById('status');
    
    if (!message) {
        status.style.display = 'none';
        return;
    }
    
    status.textContent = message;
    status.className = type;
    status.style.display = 'block';
    
    if (type === 'info') {
        setTimeout(() => {
            if (status.className === 'info') {
                status.style.display = 'none';
            }
        }, 5000);
    }
}

// ====== INITIALISATION TOTALE ======
// Initialiser la carte d√®s que possible
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        initGrist();
    });
} else {
    initMap();
    initGrist();
}
</script>
