<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Signalements - Ille-et-Vilaine</title>
    <script src="https://grist.numerique.gouv.fr/grist-plugin-api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            cursor: crosshair;
        }
        
        .instruction-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: 600;
            font-size: 14px;
            pointer-events: none;
            transition: all 0.3s;
        }
        
        .instruction-banner.step2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .geolocate-btn {
            position: absolute;
            bottom: 120px;
            right: 10px;
            z-index: 1000;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }
        
        .geolocate-btn:hover {
            background: #667eea;
            border-color: #667eea;
        }
        
        .geolocate-btn:active {
            transform: scale(0.95);
        }
        
        .geolocate-btn.loading {
            background: #ffc107;
        }
        
        .geolocate-btn.active {
            background: #28a745;
            border-color: #28a745;
        }
        
        .popup-form {
            width: 320px;
            padding: 0;
        }
        
        .popup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            margin: -15px -15px 12px -15px;
            border-radius: 12px 12px 0 0;
        }
        
        .popup-header h3 {
            margin: 0;
            font-size: 14px;
        }
        
        .popup-coords {
            font-size: 10px;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .checkbox-item input {
            width: auto;
            margin: 0;
        }
        
        .checkbox-item label {
            margin: 0;
            font-weight: 400;
            font-size: 11px;
        }
        
        .btn-submit {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .btn-submit:hover {
            opacity: 0.9;
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-cancel {
            width: 100%;
            padding: 8px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            margin-top: 6px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            text-align: center;
            font-weight: 600;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content {
            margin: 20px;
        }
    </style>
</head>
<body>
    <div id="banner" class="instruction-banner">
        üîµ Cliquez sur la carte pour marquer le D√âBUT du tron√ßon coup√©
    </div>
    
    <button id="geolocateBtn" class="geolocate-btn" title="Me localiser">
        üìç
    </button>
    
    <div id="map"></div>

    <script>
        let map;
        let tempMarker = null;
        let gristAPI = null;
        let existingMarkers = [];
        let existingLines = [];
        
        // Variables pour le mode tron√ßon
        let tronconMode = false;
        let startPoint = null;
        let startMarker = null;
        let endMarker = null;
        let tronconLine = null;
        
        const PRIORITY_COLORS = {
            'Critique': '#dc3545',
            'Haute': '#fd7e14',
            'Moyenne': '#ffc107',
            'Basse': '#28a745'
        };
        
        // ‚úÖ INITIALISATION S√âCURIS√âE - Uniquement via Widget API
        console.log('Initialisation Widget Grist...');
        grist.ready({ requiredAccess: 'full' });
        
        grist.onOptions(function(options) {
            gristAPI = grist;
            console.log('‚úÖ Grist API charg√©e et pr√™te !');
        });
        
        // Initialiser la carte
        function initMap() {
            if (typeof L === 'undefined') {
                console.log('Leaflet pas charg√©, r√©essai...');
                setTimeout(initMap, 300);
                return;
            }
            
            console.log('Initialisation carte...');
            
            map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView([48.1173, -1.6778], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 18
            }).addTo(map);
            
            map.off('locationfound');
            map.off('locationerror');
            map.on('click', onMapClick);
            
            console.log('Carte pr√™te !');
            
            loadExistingSignalements();
            setInterval(loadExistingSignalements, 30000);
        }
        
        // G√©olocalisation
        document.getElementById('geolocateBtn').addEventListener('click', geolocateUser);
        
        let userMarker = null;
        
        function geolocateUser() {
            const btn = document.getElementById('geolocateBtn');
            
            if (!navigator.geolocation) {
                alert('La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }
            
            btn.classList.add('loading');
            btn.textContent = '‚è≥';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    map.setView([lat, lng], 16);
                    
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    
                    userMarker = L.circleMarker([lat, lng], {
                        radius: 10,
                        fillColor: '#007bff',
                        color: 'white',
                        weight: 3,
                        fillOpacity: 0.8,
                        interactive: false
                    }).addTo(map);
                    
                    const pulse = L.circle([lat, lng], {
                        radius: position.coords.accuracy,
                        fillColor: '#007bff',
                        fillOpacity: 0.1,
                        color: '#007bff',
                        weight: 1,
                        interactive: false
                    }).addTo(map);
                    
                    setTimeout(() => map.removeLayer(pulse), 2000);
                    
                    btn.classList.remove('loading');
                    btn.classList.add('active');
                    btn.textContent = '‚úì';
                    
                    setTimeout(() => {
                        btn.classList.remove('active');
                        btn.textContent = 'üìç';
                    }, 2000);
                },
                (error) => {
                    console.error('Erreur g√©olocalisation:', error);
                    alert('Impossible de r√©cup√©rer votre position. V√©rifiez les autorisations.');
                    btn.classList.remove('loading');
                    btn.textContent = 'üìç';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // ‚úÖ CHARGEMENT S√âCURIS√â - Uniquement via Widget API
        async function loadExistingSignalements() {
            try {
                console.log('Chargement des signalements...');
                
                if (!gristAPI) {
                    console.warn('API Grist pas encore pr√™te, r√©essai dans 1s...');
                    setTimeout(loadExistingSignalements, 1000);
                    return;
                }
                
                const tableData = await gristAPI.docApi.fetchTable('Signalements');
                console.log('‚úÖ Donn√©es charg√©es:', tableData.id.length, 'signalement(s)');
                
                const records = tableData.id.map((id, index) => ({
                    id: id,
                    fields: {
                        Agent: tableData.Agent[index],
                        Latitude: tableData.Latitude[index],
                        Longitude: tableData.Longitude[index],
                        Latitude_fin: tableData.Latitude_fin ? tableData.Latitude_fin[index] : null,
                        Longitude_fin: tableData.Longitude_fin ? tableData.Longitude_fin[index] : null,
                        Route: tableData.Route[index],
                        Commune: tableData.Commune[index],
                        Type_coupure: tableData.Type_coupure[index],
                        Cause: tableData.Cause[index],
                        Priorite: tableData.Priorite[index],
                        Statut: tableData.Statut[index],
                        Description: tableData.Description[index],
                        Date_heure: tableData.Date_heure[index]
                    }
                }));
                
                displayExistingMarkers(records);
                
            } catch (error) {
                console.error('‚ùå Erreur chargement signalements:', error);
            }
        }
        
        function displayExistingMarkers(records) {
            existingMarkers.forEach(marker => map.removeLayer(marker));
            existingMarkers = [];
            existingLines.forEach(line => map.removeLayer(line));
            existingLines = [];
            
            records.forEach(record => {
                const fields = record.fields;
                
                if (!fields.Latitude || !fields.Longitude) return;
                if (typeof fields.Latitude !== 'number' || typeof fields.Longitude !== 'number') {
                    console.warn('Coordonn√©es invalides ignor√©es:', fields.Latitude, fields.Longitude);
                    return;
                }
                
                const color = PRIORITY_COLORS[fields.Priorite] || '#6c757d';
                const causes = Array.isArray(fields.Cause) ? fields.Cause.join(', ') : fields.Cause;
                
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #333; font-size: 15px;">
                            ${fields.Route} - ${fields.Commune}
                        </h3>
                        <div style="font-size: 13px;">
                            <p style="margin: 5px 0;"><strong>Type:</strong> ${fields.Type_coupure}</p>
                            <p style="margin: 5px 0;"><strong>Priorit√©:</strong> 
                                <span style="color: ${color}; font-weight: 600;">${fields.Priorite}</span>
                            </p>
                            <p style="margin: 5px 0;"><strong>Cause(s):</strong> ${causes}</p>
                            <p style="margin: 5px 0;"><strong>Agent:</strong> ${fields.Agent}</p>
                            <p style="margin: 5px 0;"><strong>Statut:</strong> 
                                <span style="padding: 2px 6px; border-radius: 3px; font-size: 11px; 
                                    background: ${fields.Statut === 'Actif' ? '#fee' : '#efe'}; 
                                    color: ${fields.Statut === 'Actif' ? '#c00' : '#080'};">
                                    ${fields.Statut}
                                </span>
                            </p>
                            ${fields.Description ? `<p style="margin: 5px 0;"><strong>Description:</strong><br>${fields.Description}</p>` : ''}
                            <p style="margin: 5px 0; font-size: 11px; color: #999;">
                                ${new Date(fields.Date_heure < 1e12 ? fields.Date_heure * 1000 : fields.Date_heure).toLocaleString('fr-FR')}
                            </p>
                        </div>
                    </div>
                `;
                
                const isTroncon = fields.Latitude_fin && fields.Longitude_fin && 
                                  typeof fields.Latitude_fin === 'number' && 
                                  typeof fields.Longitude_fin === 'number';
                
                if (isTroncon) {
                    const line = L.polyline(
                        [[fields.Latitude, fields.Longitude], [fields.Latitude_fin, fields.Longitude_fin]], 
                        {
                            color: color,
                            weight: 6,
                            opacity: fields.Statut === 'Resolu' ? 0.4 : 0.8
                        }
                    )
                    .bindPopup(popupContent)
                    .bindTooltip(`${fields.Route} - ${fields.Priorite}`, {
                        permanent: false,
                        direction: 'center'
                    })
                    .addTo(map);
                    
                    existingLines.push(line);
                    
                    const startIcon = L.circleMarker([fields.Latitude, fields.Longitude], {
                        radius: 6,
                        fillColor: color,
                        color: 'white',
                        weight: 2,
                        fillOpacity: fields.Statut === 'Resolu' ? 0.4 : 1
                    })
                    .bindPopup(popupContent)
                    .bindTooltip('üîµ D√©but', { permanent: false, direction: 'top' })
                    .addTo(map);
                    
                    const endIcon = L.circleMarker([fields.Latitude_fin, fields.Longitude_fin], {
                        radius: 6,
                        fillColor: color,
                        color: 'white',
                        weight: 2,
                        fillOpacity: fields.Statut === 'Resolu' ? 0.4 : 1
                    })
                    .bindPopup(popupContent)
                    .bindTooltip('üî¥ Fin', { permanent: false, direction: 'top' })
                    .addTo(map);
                    
                    existingMarkers.push(startIcon, endIcon);
                    
                } else {
                    const icon = L.divIcon({
                        className: 'existing-marker',
                        html: `<div style="
                            background: ${color};
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                            ${fields.Statut === 'Resolu' ? 'opacity: 0.5;' : ''}
                        "></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const marker = L.marker([fields.Latitude, fields.Longitude], { icon: icon })
                        .bindPopup(popupContent)
                        .addTo(map);
                    
                    existingMarkers.push(marker);
                }
            });
        }
        
        async function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            if (!tronconMode) {
                startPoint = { lat: lat, lng: lng };
                tronconMode = true;
                
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: '#007bff',
                    color: 'white',
                    weight: 3,
                    fillOpacity: 1
                }).addTo(map);
                
                document.getElementById('banner').textContent = 'üî¥ Cliquez pour marquer la FIN du tron√ßon coup√©';
                document.getElementById('banner').classList.add('step2');
                
            } else {
                const endPoint = { lat: lat, lng: lng };
                
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: '#dc3545',
                    color: 'white',
                    weight: 3,
                    fillOpacity: 1
                }).addTo(map);
                
                if (tronconLine) map.removeLayer(tronconLine);
                tronconLine = L.polyline(
                    [[startPoint.lat, startPoint.lng], [endPoint.lat, endPoint.lng]], 
                    {
                        color: '#dc3545',
                        weight: 5,
                        opacity: 0.7
                    }
                ).addTo(map);
                
                const distance = calculateDistance(startPoint.lat, startPoint.lng, lat, lng);
                
                const midLat = (startPoint.lat + lat) / 2;
                const midLng = (startPoint.lng + lng) / 2;
                
                const adresseInfo = await getRouteInfo(midLat, midLng);
                
                showFormPopup(startPoint, endPoint, distance, adresseInfo);
                
                document.getElementById('banner').textContent = 'üîµ Cliquez pour marquer le D√âBUT du tron√ßon coup√©';
                document.getElementById('banner').classList.remove('step2');
                tronconMode = false;
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c * 1000).toFixed(0);
        }
        
        async function getRouteInfo(lat, lng) {
            let routeInfo = { route: '', commune: '' };

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&extratags=1`,
                    {
                        headers: {
                            "User-Agent": "Widget-Grist-Routes/1.0"
                        }
                    }
                );

                const data = await response.json();

                if (data.address) {
                    routeInfo.commune = data.address.city || data.address.town || data.address.village || "";
                    routeInfo.route = data.address.road || "";
                }

                if (data.extratags && data.extratags.ref) {
                    routeInfo.route = data.extratags.ref;
                }

                if (!routeInfo.route) {
                    const overpassQuery = `
                        [out:json];
                        way(around:50,${lat},${lng})["highway"]["ref"];
                        out tags;
                    `;
                    const response2 = await fetch("https://overpass-api.de/api/interpreter", {
                        method: "POST",
                        body: overpassQuery
                    });
                    const data2 = await response2.json();

                    if (data2.elements && data2.elements.length > 0) {
                        const road = data2.elements[0];
                        if (road.tags && road.tags.ref) {
                            routeInfo.route = road.tags.ref;
                        }
                    }
                }
            } catch (error) {
                console.error("Erreur r√©cup√©ration route:", error);
            }

            return routeInfo;
        }
        
        function showFormPopup(startPoint, endPoint, distance, adresseInfo) {
            const midLat = (startPoint.lat + endPoint.lat) / 2;
            const midLng = (startPoint.lng + endPoint.lng) / 2;
            const popupContent = `
                <div class="popup-form">
                    <div class="popup-header">
                        <h3>üìç Nouveau signalement - Tron√ßon</h3>
                        <div class="popup-coords">
                            Longueur: ${distance}m
                            <br>D√©but: ${startPoint.lat.toFixed(6)}, ${startPoint.lng.toFixed(6)}
                            <br>Fin: ${endPoint.lat.toFixed(6)}, ${endPoint.lng.toFixed(6)}
                        </div>
                    </div>
                    
                    <div id="message"></div>
                    
                    <div class="form-group">
                        <label>Nom de l'agent *</label>
                        <input type="text" id="agent" placeholder="Ex: Jean Dupont" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Route *</label>
                        <input type="text" id="route" value="${adresseInfo.route}" placeholder="Ex: D137" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Commune *</label>
                        <input type="text" id="commune" value="${adresseInfo.commune}" placeholder="Ex: Rennes" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Type de coupure *</label>
                        <select id="typeCoupure">
                            <option value="Totale">Totale</option>
                            <option value="Partielle">Partielle</option>
                            <option value="D√©viation">D√©viation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Cause(s) *</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="c1" value="Inondation">
                                <label for="c1">Inondation</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c2" value="Accident">
                                <label for="c2">Accident</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c3" value="Travaux">
                                <label for="c3">Travaux</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c4" value="Arbre">
                                <label for="c4">Arbre</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c5" value="Glissement">
                                <label for="c5">Glissement</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="c6" value="Autre">
                                <label for="c6">Autre</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Priorit√© *</label>
                        <select id="priorite">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="description" rows="3" placeholder="D√©tails..."></textarea>
                    </div>
                    
                    <button class="btn-submit" onclick="submitSignalement(${startPoint.lat}, ${startPoint.lng}, ${endPoint.lat}, ${endPoint.lng}, ${distance})">
                        ‚úì Cr√©er le signalement
                    </button>
                    
                    <button class="btn-cancel" onclick="cancelSignalement()">
                        Annuler
                    </button>
                </div>
            `;
            
            const popup = L.popup({
                maxWidth: 350,
                maxHeight: window.innerHeight * 0.8,
                closeButton: false,
                autoPan: true,
                keepInView: true
            })
            .setLatLng([midLat, midLng])
            .setContent(popupContent)
            .openOn(map);
        }
        
        // ‚úÖ ENVOI S√âCURIS√â - Uniquement via Widget API
        window.submitSignalement = async function(startLat, startLng, endLat, endLng, distance) {
            console.log('üì§ Envoi signalement...');
            
            const agent = document.getElementById('agent').value.trim();
            const route = document.getElementById('route').value.trim();
            const commune = document.getElementById('commune').value.trim();
            const typeCoupure = document.getElementById('typeCoupure').value;
            const priorite = document.getElementById('priorite').value;
            let description = document.getElementById('description').value.trim();
            
            description = `Tron√ßon de ${distance}m${description ? ' - ' + description : ''}`;
            
            const causes = [];
            for (let i = 1; i <= 6; i++) {
                const cb = document.getElementById('c' + i);
                if (cb && cb.checked) causes.push(cb.value);
            }
            
            if (!agent || !route || !commune) {
                showPopupMessage('error', 'Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (causes.length === 0) {
                showPopupMessage('error', 'S√©lectionnez au moins une cause');
                return;
            }
            
            const btn = document.querySelector('.btn-submit');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>Envoi...';
            
            try {
                if (!gristAPI) {
                    throw new Error('API Grist non disponible');
                }
                
                const record = {
                    Date_heure: new Date().toISOString(),
                    Agent: agent,
                    Latitude: startLat,
                    Longitude: startLng,
                    Latitude_fin: endLat,
                    Longitude_fin: endLng,
                    Route: route,
                    Commune: commune,
                    Type_coupure: typeCoupure,
                    Cause: ['L', ...causes],
                    Description: description,
                    Statut: 'Actif',
                    Priorite: priorite
                };
                
                console.log('üìù Enregistrement:', record);
                
                await gristAPI.docApi.applyUserActions([
                    ['AddRecord', 'Signalements', null, record]
                ]);
                
                console.log('‚úÖ Signalement cr√©√© !');
                showPopupMessage('success', '‚úì Signalement cr√©√© !');
                
                setTimeout(() => {
                    loadExistingSignalements();
                }, 500);
                
                setTimeout(() => {
                    map.closePopup();
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showPopupMessage('error', 'Erreur lors de la cr√©ation: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '‚úì Cr√©er le signalement';
            }
        };
        
        window.cancelSignalement = function() {
            map.closePopup();
            
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
            }
            if (tronconLine) {
                map.removeLayer(tronconLine);
                tronconLine = null;
            }
            
            tronconMode = false;
            startPoint = null;
            document.getElementById('banner').textContent = 'üîµ Cliquez pour marquer le D√âBUT du tron√ßon coup√©';
            document.getElementById('banner').classList.remove('step2');
        };
        
        function showPopupMessage(type, text) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type === 'success' ? 'success-message' : 'error-message';
            msgDiv.textContent = text;
            msgDiv.style.display = 'block';
        }
        
        setTimeout(initMap, 1000);
    </script>
</body>
</html>
