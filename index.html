<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Widget Cartographique</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; background: white; min-height: 100vh; }
        .header { background: #2c3e50; color: white; padding: 20px 30px; border-bottom: 3px solid #34495e; }
        .header h1 { font-size: 22px; font-weight: 600; margin-bottom: 5px; }
        .header p { font-size: 13px; color: #bdc3c7; }
        .tabs { display: flex; background: #ecf0f1; border-bottom: 2px solid #bdc3c7; padding: 0 20px; }
        .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 14px; font-weight: 500; color: #7f8c8d; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab:hover { color: #2c3e50; background: #dfe6e9; }
        .tab.active { color: #2c3e50; border-bottom-color: #3498db; background: white; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { margin-bottom: 30px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 8px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select, .form-group textarea { width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 13px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .checkbox-group { margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; }
        .geom-config { display: grid; grid-template-columns: 100px 1fr; gap: 15px; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px; }
        .color-input { width: 60px; height: 35px; border: 1px solid #bdc3c7; border-radius: 4px; cursor: pointer; }
        .field-list { border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; padding: 15px; }
        .field-item { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 10px; }
        .field-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; padding: 6px 12px; font-size: 12px; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .info-box { background: #e8f4f8; border-left: 4px solid #3498db; padding: 12px 15px; margin: 15px 0; font-size: 13px; color: #2c3e50; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px 15px; margin: 15px 0; font-size: 13px; color: #856404; }
        .source-item { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 10px; }
        .footer { background: #ecf0f1; padding: 20px 30px; border-top: 2px solid #bdc3c7; display: flex; justify-content: space-between; align-items: center; position: fixed; bottom: 0; width: 100%; max-width: 1200px; }
        .footer-info { font-size: 13px; color: #7f8c8d; }
        .code-output { background: #2c3e50; color: #ecf0f1; padding: 20px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.5; overflow-x: auto; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .range-container { display: flex; align-items: center; gap: 15px; }
        .range-container input[type="range"] { flex: 1; }
        .range-value { font-weight: 600; color: #2c3e50; min-width: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Générateur de Widget Cartographique Grist</h1>
            <p>Configuration et génération de widgets personnalisés</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('general')">Général</button>
            <button class="tab" onclick="switchTab('carte')">Carte</button>
            <button class="tab" onclick="switchTab('geometries')">Géométries</button>
            <button class="tab" onclick="switchTab('formulaire')">Formulaire</button>
            <button class="tab" onclick="switchTab('sources')">Sources</button>
            <button class="tab" onclick="switchTab('export')">Export</button>
        </div>
        
        <div class="content" style="padding-bottom: 80px;">
            <div id="tab-general" class="tab-content active">
                <div class="section">
                    <div class="section-title">Informations projet</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nom configuration</label>
                            <input type="text" id="config_name" value="Cartographie">
                        </div>
                        <div class="form-group">
                            <label>Table Grist cible</label>
                            <input type="text" id="table_name" value="Donnees">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="tab-carte" class="tab-content">
                <div class="section">
                    <div class="section-title">Position initiale</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Latitude</label>
                            <input type="number" id="map_lat" value="48.1173" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>Longitude</label>
                            <input type="number" id="map_lng" value="-1.6778" step="0.0001">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Zoom</label>
                        <div class="range-container">
                            <input type="range" id="map_zoom" min="1" max="18" value="10">
                            <span class="range-value" id="zoom_value">10</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Fond de carte</label>
                        <select id="base_layer">
                            <option value="osm">OpenStreetMap</option>
                            <option value="satellite">Satellite</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="tab-geometries" class="tab-content">
                <div class="section">
                    <div class="section-title">Types géométries</div>
                    <div class="geom-config">
                        <input type="checkbox" id="geom_point" checked>
                        <div>
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">Points</label>
                            <div style="display: flex; gap: 15px;">
                                <div><label style="font-size: 12px;">Couleur</label>
                                <input type="color" id="point_color" value="#dc3545" class="color-input"></div>
                            </div>
                        </div>
                    </div>
                    <div class="geom-config">
                        <input type="checkbox" id="geom_line" checked>
                        <div>
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">Lignes</label>
                            <div style="display: flex; gap: 15px;">
                                <div><label style="font-size: 12px;">Couleur</label>
                                <input type="color" id="line_color" value="#007bff" class="color-input"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="tab-formulaire" class="tab-content">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <div class="section-title" style="margin: 0;">Champs formulaire</div>
                        <button class="btn btn-primary" onclick="addFormField()">Ajouter</button>
                    </div>
                    <div id="form_fields" class="field-list"></div>
                </div>
            </div>
            
            <div id="tab-sources" class="tab-content">
                <div class="section">
                    <div class="section-title">Sources externes (optionnel)</div>
                    <div id="external_sources">
                        <p style="text-align: center; color: #999; padding: 20px;">Fonctionnalité à venir</p>
                    </div>
                </div>
            </div>
            
            <div id="tab-export" class="tab-content">
                <div class="section">
                    <div class="section-title">Génération widget</div>
                    <button class="btn btn-success" onclick="generateWidget()">Générer le code</button>
                    <div id="output_container" style="display: none; margin-top: 20px;">
                        <pre id="generated_code" class="code-output"></pre>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="copyToClipboard()">Copier</button>
                            <button class="btn btn-secondary" onclick="downloadWidget()">Télécharger</button>
                        </div>
                        <div class="info-box">
                            <strong>Installation :</strong> Copiez le code → Grist → Nouveau widget Custom → Collez → Access "Full document"
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div class="footer-info"><strong>Config:</strong> <span id="footer_config_name">-</span></div>
            <div class="footer-info"><strong>Table:</strong> <span id="footer_table_name">-</span></div>
        </div>
    </div>
    
    <script>
        let formFields = [];
        let fieldIdCounter = 1;
        
        document.addEventListener('DOMContentLoaded', function() {
            addFormField('route', 'Route', 'text', true);
            addFormField('commune', 'Commune', 'text', true);
            addFormField('statut', 'Statut', 'select', true, 'Actif,Résolu');
            
            document.getElementById('config_name').addEventListener('input', updateFooter);
            document.getElementById('table_name').addEventListener('input', updateFooter);
            document.getElementById('map_zoom').addEventListener('input', function() {
                document.getElementById('zoom_value').textContent = this.value;
            });
            updateFooter();
        });
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        function updateFooter() {
            document.getElementById('footer_config_name').textContent = 
                document.getElementById('config_name').value || '-';
            document.getElementById('footer_table_name').textContent = 
                document.getElementById('table_name').value || '-';
        }
        
        function addFormField(name = '', label = '', type = 'text', required = false, options = '') {
            const id = fieldIdCounter++;
            formFields.push({ id, name, label, type, required, options });
            renderFormFields();
        }
        
        function removeFormField(id) {
            formFields = formFields.filter(f => f.id !== id);
            renderFormFields();
        }
        
        function updateFormField(id, key, value) {
            const field = formFields.find(f => f.id === id);
            if (field) field[key] = value;
        }
        
        function renderFormFields() {
            const container = document.getElementById('form_fields');
            if (formFields.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucun champ</p>';
                return;
            }
            container.innerHTML = formFields.map(field => `
                <div class="field-item">
                    <div class="field-controls">
                        <div><label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Nom</label>
                        <input type="text" value="${field.name}" onchange="updateFormField(${field.id}, 'name', this.value)" style="width: 100%; padding: 6px; font-size: 12px;"></div>
                        <div><label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Label</label>
                        <input type="text" value="${field.label}" onchange="updateFormField(${field.id}, 'label', this.value)" style="width: 100%; padding: 6px; font-size: 12px;"></div>
                        <div><label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Type</label>
                        <select onchange="updateFormField(${field.id}, 'type', this.value); renderFormFields();" style="width: 100%; padding: 6px; font-size: 12px;">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texte</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>Nombre</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Liste</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>Zone texte</option>
                            <option value="date" ${field.type === 'date' ? 'selected' : ''}>Date</option>
                            <option value="datetime-local" ${field.type === 'datetime-local' ? 'selected' : ''}>Date+heure</option>
                        </select></div>
                    </div>
                    ${field.type === 'select' ? `<div style="margin-top: 10px;"><label style="font-size: 11px; color: #666;">Options (virgules)</label>
                    <input type="text" value="${field.options}" onchange="updateFormField(${field.id}, 'options', this.value)" style="width: 100%; padding: 6px; font-size: 12px;"></div>` : ''}
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <label style="font-size: 12px;"><input type="checkbox" ${field.required ? 'checked' : ''} onchange="updateFormField(${field.id}, 'required', this.checked)"> Requis</label>
                        <button class="btn btn-danger" onclick="removeFormField(${field.id})">Suppr</button>
                    </div>
                </div>
            `).join('');
        }
        
        function generateWidget() {
            const config = {
                name: document.getElementById('config_name').value,
                table: document.getElementById('table_name').value,
                map: {
                    lat: parseFloat(document.getElementById('map_lat').value),
                    lng: parseFloat(document.getElementById('map_lng').value),
                    zoom: parseInt(document.getElementById('map_zoom').value),
                    baseLayer: document.getElementById('base_layer').value
                },
                geometries: {
                    point: { enabled: document.getElementById('geom_point').checked, color: document.getElementById('point_color').value },
                    line: { enabled: document.getElementById('geom_line').checked, color: document.getElementById('line_color').value }
                },
                fields: formFields
            };
            
            const code = generateHTMLCode(config);
            document.getElementById('generated_code').textContent = code;
            document.getElementById('output_container').style.display = 'block';
        }
        
        function generateHTMLCode(config) {
            const fieldsHTML = config.fields.map(f => {
                if (f.type === 'select') {
                    const opts = f.options.split(',').map(o => `<option>${o.trim()}</option>`).join('');
                    return `<div class="form-group"><label>${f.label}${f.required ? ' *' : ''}</label><select id="field_${f.name}" ${f.required ? 'required' : ''}><option value="">-</option>${opts}</select></div>`;
                } else if (f.type === 'textarea') {
                    return `<div class="form-group"><label>${f.label}${f.required ? ' *' : ''}</label><textarea id="field_${f.name}" rows="3" ${f.required ? 'required' : ''}></textarea></div>`;
                } else {
                    return `<div class="form-group"><label>${f.label}${f.required ? ' *' : ''}</label><input type="${f.type}" id="field_${f.name}" ${f.required ? 'required' : ''}></div>`;
                }
            }).join('\\n');
            
            const fieldsSave = config.fields.map(f => `${f.name}: document.getElementById('field_${f.name}').value`).join(',\\n                ');
            
            return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>${config.name}</title>
    <script src="https://grist.numerique.gouv.fr/grist-plugin-api.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .mode-selector { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .mode-btn { padding: 8px 16px; margin: 5px; background: #ccc; border: none; border-radius: 4px; cursor: pointer; }
        .mode-btn.active { background: #3498db; color: white; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .btn-submit { width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-cancel { width: 100%; padding: 8px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="mode-selector">
        ${config.geometries.point.enabled ? '<button class="mode-btn" data-mode="point" onclick="selectMode(\\'point\\')">Point</button>' : ''}
        ${config.geometries.line.enabled ? '<button class="mode-btn" data-mode="line" onclick="selectMode(\\'line\\')">Ligne</button>' : ''}
    </div>
    <div id="map"></div>
    
    <script>
        let map, gristAPI, currentMode, currentGeometry, drawnItems;
        const POINT_COLOR = '${config.geometries.point.color}';
        const LINE_COLOR = '${config.geometries.line.color}';
        
        grist.ready({ requiredAccess: 'full' });
        grist.onOptions(function() { gristAPI = grist; });
        
        function initMap() {
            map = L.map('map').setView([${config.map.lat}, ${config.map.lng}], ${config.map.zoom});
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            drawnItems = new L.FeatureGroup().addTo(map);
            map.on('click', onMapClick);
        }
        
        function selectMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-mode="' + mode + '"]').classList.add('active');
            drawnItems.clearLayers();
        }
        
        function onMapClick(e) {
            if (!currentMode || currentMode !== 'point') return;
            drawnItems.clearLayers();
            L.circleMarker([e.latlng.lat, e.latlng.lng], {
                radius: 8, fillColor: POINT_COLOR, color: 'white', weight: 2, fillOpacity: 1
            }).addTo(drawnItems);
            currentGeometry = { type: 'Point', coordinates: [e.latlng.lng, e.latlng.lat] };
            showForm();
        }
        
        function showForm() {
            const popup = L.popup()
                .setLatLng(map.getCenter())
                .setContent(\`
                    <div style="width: 300px;">
                        <h3 style="margin-bottom: 10px;">Nouveau signalement</h3>
                        ${fieldsHTML}
                        <button class="btn-submit" onclick="saveData()">Enregistrer</button>
                        <button class="btn-cancel" onclick="map.closePopup()">Annuler</button>
                    </div>
                \`)
                .openOn(map);
        }
        
        async function saveData() {
            try {
                const data = {
                    ${fieldsSave},
                    geojson: JSON.stringify(currentGeometry),
                    date: new Date().toISOString()
                };
                await gristAPI.docApi.applyUserActions([
                    ['AddRecord', '${config.table}', null, data]
                ]);
                alert('Enregistré !');
                map.closePopup();
                drawnItems.clearLayers();
                currentMode = null;
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            } catch(error) {
                alert('Erreur: ' + error.message);
            }
        }
        
        setTimeout(initMap, 500);
    </script>
</body>
</html>`;
        }
        
        function copyToClipboard() {
            const code = document.getElementById('generated_code').textContent;
            navigator.clipboard.writeText(code).then(() => alert('Code copié !'));
        }
        
        function downloadWidget() {
            const code = document.getElementById('generated_code').textContent;
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'widget-carto.html';
            a.click();
        }
    </script>
</body>
</html>
